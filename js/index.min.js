/// <reference path="jquery.min.js" />
/// <reference path="rsseasy.js" />

$(function () {
    var hash = {"uid": "", "sid": ""};
    if (location.hash) {
        hash = eval("(" + location.hash.replace("#", "{").replace(/:/g, ':"').replace(",", '",') + "\"})");
    }
//    var right = $("#right"), tagbar = right.find("ul"), ifrwrap = right.find('div');
//    var leftbar = $("#left");
//    $("#controlbtn").click(function (ev) {
//        switch (leftbar.offset().left) {
//            case 0:
//                leftbar.animate({"left": -leftbar.width()-50}, 500);
//                right.animate({"left": 50}, 500);
//                break;
//            case - leftbar.width()-50:
//                leftbar.animate({"left": 0}, 500);
//                right.animate({"left": leftbar.width()}, 500);
//                break;
//        }
//    });
    //权限验证
    var powerlist = Cookie.Get("powerlist") || "";
    powerlist = powerlist.split(",");
    var len = powerlist.length;
    for (var i = 0; i < len; i++) {
        powerlist[i] = parseInt(powerlist[i]).toString(2).padleft(53, '0');
    }
    powerlist = "0" + powerlist.join("");
    function powervalidate(powerid) {
        return Cookie.Get("staffmyid") == "1" || parseInt(powerlist.substr(powerid, 1));
    }
    //导航栏
    var navbar = $("#nav");//一级菜单ul
    var powerid = 0;
    $.each(menudata, function (k, v) {//轮询菜单数据从一级开始
        powerid = v["powerid"];
        //alert("id::"+k);//k为一级菜单id,'my','top2'...这些，v为k下面的所有属性text,powerid...
        if (!powerid || powervalidate(powerid)) {
            navbar.append('<li id="' + k + '">' + v['text'] + '</li>');
        }
    });
    if (RssFrame.RootMenu["frame"]) {
        RssFrame.RootMenu["frame"]();
    }
    var navli = navbar.find("li");//一级菜单行li
    var leftMenus = $("#leftMenus");//二级菜单ul
    navli.click(function () {//一级菜单click事件
        navli.removeClass();
        var nav = $(this);
        nav.addClass("actived");

        hash.uid = this.id;

        leftMenus.empty();


        var children = menudata[this.id]['children'];
        $.each(children, function (uk, v) {//构造二级菜单
            var children = v["children"];
            powerid = v["powerid"];
            if (!powerid || powervalidate(powerid)) {
                //alert("children::"+children);
                if (children) {
                    var dl = $("<dl><dt>" + v["text"] + "<img src='../css/limg/l1.png'></dt></dl>");//二级菜单带向下三角形
                    var dd = $("<dd></dd>");//三级菜单
                    dl.append(dd);
                    leftMenus.append($("<li class='reset'></li>").append(dl));//二级菜单上先添加个功能导航reset
                    $.each(children, function (k, v) {//构造三级菜单
                        powerid = v["powerid"];
                        if (!powerid || powervalidate(powerid)) {
                            dd.append('<p id="' + hash.uid + uk + k + '" href="' + v['url'] + '">' + v["text"] + '</p>');//构造三级菜单p都在三级菜单
                        }
                    });
                    dl.find("dt").click(function () {//点击二级菜单
                        dd.slideToggle();
                        var ind = $(this).parents("li").index();
                        if (ind != "0") {
                            if ($(this).attr("hhh")) {
                                $(this).find("img").attr("src", "../css/limg/l1.png");
                                $(this).css("color", "#000")
                                $(this).removeAttr("hhh")
                            } else {
                                $("#leftMenus").find("dt[hhh='0']").click();
                                $(this).find("img").attr("src", "../css/limg/sl1.png")
                                $(this).css("color", "#fff")
                                $(this).attr("hhh", "0")
                            }
                        }
                    });
                    return;
                }//if (children) {
               // alert("testing..");没有被执行
                leftMenus.append('<li><p id="' + hash.uid + uk + k + '" href="' + v['url'] + '">' + v["text"] + '</p></li>');
            }
        });
        leftMenus.find(".reset").eq(0).attr("id", "controlbtn")//二级功能导航
        $("#controlbtn").find("dt").find("img").attr("src", "../css/limg/l0.png")//二级功能导航展开的图标
        if ($("#left").css("left") == "-265px") {//左大区缩进去
//          $("#controlbtn").css("width","245px") 
            $("#controlbtn").find("dt").find("img").attr("src", "../css/limg/sl0.png")////二级功能导航缩进的图标
        }
       //大右区域div，右上tag ul，右下区域ifrwrap div
        var right = $("#right"), tagbar = right.find("ul"), ifrwrap = right.find('div');
        var leftbar = $("#left");//大左区域
        leftbar.css("overflow", "overlay");//大左区域
        leftbar.css({"left": 0, "width": "175"});//大左区域
        leftMenus.find(".reset").eq(0).css({"width": "175"});//功能导航栏
        leftMenus.find(".reset").eq(0).find("dt").find("img").attr("src", "../css/limg/l0.png")//功能导航栏展开的图标
        right.css("left", "175");//大右区域
        $("#controlbtn").click(function (ev) {//功能导航栏点击
            switch (leftbar.offset().left) {
                case 0:
                    leftbar.css("overflow", "hidden");
                    leftbar.animate({"left": -leftbar.width(), "width": "205"}, 500);
                    leftMenus.find(".reset").eq(0).animate({"width": "215"}, 500);
                    leftMenus.find(".reset").eq(0).find("dt").find("img").attr("src", "../css/limg/sl0.png")
                    right.animate({"left": 30}, 500);
                    break;
                default:
                    leftbar.css("overflow", "auto");
                    leftbar.animate({"left": 0, "width": "175"}, 500);
                    leftMenus.find(".reset").eq(0).animate({"width": "175"}, 500);//leftMenus是大左区域的ul
                    leftMenus.find(".reset").eq(0).find("dt").find("img").attr("src", "../css/limg/l0.png")
                    right.animate({"left": "175"}, 500);
                    break;
            }
        });

        if (RssFrame.LeftMenu[hash.uid]) {
            RssFrame.LeftMenu[hash.uid]();
        }
        var plist = leftMenus.find("p");//三级菜单
        //alert("plist::"+plist);
        plist.click(function (ev) {//点击三级菜单
            //alert("wwwwwww");
            RssWin.MaskLayer.show();
            ev.preventDefault();
            var menu = $(this);
            hash.sid = this.id;
            top.location.hash = "#uid:" + hash.uid + ",sid:" + hash.sid;

            var tmphash = top.location.hash.replace(/#|,|:/img, '');

            var sm = $("#" + tmphash);
            if (sm.length) {
                sm.click();
                return;
            }
            if (tagbar.find("li").length > 8) {//tagbar ul
                RssWin.MaskLayer.close();
                alert("打开的标签过多！");
                return;
            }
            //构造三级菜单的tab li
            var tabli = $('<li id="' + tmphash + '">' + $(this).text() + '<b>×</b></li>');
            tagbar.append(tabli);//tagbar ul添加tab ui
            ifrwrap.find("iframe").hide();//ifrwrap div
            var ifr = $('<iframe src="' + $(this).attr("href") + '"></iframe>');
            ifrwrap.append(ifr);//ifrwrap div添加iframe
            ifr.load(function () {
                popuplayer.close();
                this.onload = null;
            });
            tabli.click(function () {//tab ui 三级菜单的tab li标签点击
                $('#right li').removeClass();
                tabli.addClass("actived");

                plist.removeClass("selected");
                menu.addClass("selected");

                navli.removeClass();
                nav.addClass("actived");
                RssWin.MaskLayer.close();

                ifrwrap.find("iframe").hide().removeAttr("id").removeAttr("name").eq($(this).index()).show().attr({"id": "workspace", "name": "workspace"});
            }).click();
            tabli.find("b").click(function (ev) {//tab ui 三级菜单的tab li标签中的X点击,则关闭tab
                if (tabli.prev().length) {
                    tabli.prev().click();
                } else {
                    tabli.next().click();
                }
                ev.stopPropagation();
                tabli.remove();//tab li标签删除
                ifr.remove();//iframe标签删除
            });
            tabli.mousedown(function () {//tab li标签
                return false;
            });
            tabli.dblclick(function () {//tab li标签双击关闭
                $(this).find("b").click();
            });
            popuplayer.showHtml('<div class="infowrap">正在加载，请稍候</div>', "信息提示", {"width": 300, height: 50});
        });
        var smenu = hash["sid"] && hash["sid"].indexOf(hash.uid) == 0 ? $("#" + hash["sid"]) : plist.first();
        smenu.click();
    });//navli.click(function () {//一级菜单click事件
    if (hash["uid"]) {
        $("#" + hash["uid"]).click();
    } else {
        navli.first().click();
    }
});

